name: Auto-merge codex PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: startsWith(github.event.pull_request.head.ref, 'codex/') && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const pr_number = pr.number;

            // Wait a bit for GitHub to finish computing mergeability
            for (let i = 0; i < 12; i++) { // ~60s
              const { data } = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
              core.info(`mergeable=${data.mergeable}, mergeable_state=${data.mergeable_state}`);

              // mergeable can be null while GitHub computes it
              if (data.mergeable === true) break;
              if (data.mergeable === false) {
                core.setFailed(`Not mergeable: ${data.mergeable_state}`);
                return;
              }
              await new Promise(r => setTimeout(r, 5000));
            }

            const { data: final } = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            if (final.mergeable !== true) {
              core.setFailed(`Still not mergeable (mergeable=${final.mergeable}, state=${final.mergeable_state})`);
              return;
            }

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr_number,
              merge_method: "squash"
            });

            core.info(`Merged PR #${pr_number}`);
