name: Auto-merge codex PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    if: startsWith(github.head_ref, 'codex/') && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr_number = context.payload.pull_request.number;

            async function getPR() {
              const { data } = await github.graphql(`
                query($owner:String!, $repo:String!, $number:Int!) {
                  repository(owner:$owner, name:$repo) {
                    pullRequest(number:$number) {
                      id
                      mergeStateStatus
                      mergeable
                    }
                  }
                }`, { owner, repo, number: pr_number });
              return data.repository.pullRequest;
            }

            // Retry loop: GitHub can report UNSTABLE/UNKNOWN briefly right after updates
            let pr;
            for (let i = 0; i < 12; i++) { // ~60s max
              pr = await getPR();
              core.info(`mergeStateStatus=${pr.mergeStateStatus}, mergeable=${pr.mergeable}`);
              if (pr.mergeStateStatus === "CLEAN" || pr.mergeStateStatus === "HAS_HOOKS") break;
              if (pr.mergeStateStatus === "DIRTY") {
                core.setFailed("PR has merge conflicts (DIRTY).");
                return;
              }
              await new Promise(r => setTimeout(r, 5000));
            }

            if (!(pr.mergeStateStatus === "CLEAN" || pr.mergeStateStatus === "HAS_HOOKS")) {
              core.setFailed(`PR still not stable: ${pr.mergeStateStatus}`);
              return;
            }

            await github.graphql(`
              mutation($prId: ID!) {
                enablePullRequestAutoMerge(input: {pullRequestId: $prId, mergeMethod: SQUASH}) {
                  pullRequest { number, autoMergeRequest { enabledAt } }
                }
              }`, { prId: pr.id });

            core.info(`Enabled auto-merge for PR #${pr_number}`);
