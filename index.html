<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infinite Rhythm Trainer</title>
    <script>
      const ASSET_PATHS = {
        css: 'style.css',
        js: 'main.js',
      };

      async function resolveAssetVersion(path) {
        try {
          const response = await fetch(path, { method: 'HEAD', cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Unable to resolve version for ${path}`);
          }

          const etag = response.headers.get('etag');
          if (etag) {
            return encodeURIComponent(etag.replaceAll('"', ''));
          }

          const lastModified = response.headers.get('last-modified');
          if (lastModified) {
            return encodeURIComponent(lastModified);
          }
        } catch (error) {
          console.warn('Asset version lookup failed, using runtime fallback.', error);
        }

        return `${Date.now()}`;
      }

      async function loadVersionedAssets() {
        const [cssVersion, jsVersion] = await Promise.all([
          resolveAssetVersion(ASSET_PATHS.css),
          resolveAssetVersion(ASSET_PATHS.js),
        ]);

        const stylesLink = document.createElement('link');
        stylesLink.rel = 'stylesheet';
        stylesLink.href = `${ASSET_PATHS.css}?v=${cssVersion}`;
        document.head.appendChild(stylesLink);

        const appScript = document.createElement('script');
        appScript.src = `${ASSET_PATHS.js}?v=${jsVersion}`;
        document.head.appendChild(appScript);
      }

      loadVersionedAssets();
    </script>
  </head>
  <body>
    <main class="app">
      <section class="game">
        <label>
          BPM: <span id="bpmValue">90</span>
          <input id="bpm" type="range" min="40" max="120" value="90" />
        </label>

        <button id="startStop" type="button">Start</button>

        <button id="tapZone" class="tap-zone" aria-label="Tap input zone">
          <span>Tap</span>
        </button>
      </section>

      <section class="controls card">
        <label>
          Input latency offset (ms): <span id="latencyValue">15</span>
          <input id="latency" type="range" min="0" max="200" step="5" value="15" />
        </label>

        <p id="calibrationResult" class="calibration-result">Calibration non lanc√©e.</p>

        <div class="control-buttons">
          <button id="calibration" type="button">Calibration</button>
          <button id="clearCache" type="button">Reset parameters</button>
        </div>
      </section>

      <details class="probabilities card" id="probabilitiesPanel">
        <summary>Settings</summary>

        <label>
          Hit window (ms): <span id="hitWindowDisplay">250</span>
          <input id="hitWindow" type="range" min="250" max="250" step="1" value="250" />
        </label>

        <label>
          Hit tolerance: <span id="hitToleranceDisplay">50 (125 ms)</span>
          <input id="hitTolerance" type="range" min="0" max="100" step="1" value="50" />
        </label>

        <fieldset>
          <legend>First hit index weights</legend>
          <label>
            Index 2 weight: <span id="weightFirst2Value">5</span>
            <input id="weightFirst2" type="range" min="0" max="10" step="1" value="5" />
          </label>
          <label>
            Index 3 weight: <span id="weightFirst3Value">10</span>
            <input id="weightFirst3" type="range" min="0" max="10" step="1" value="10" />
          </label>
          <label>
            Index 4 weight: <span id="weightFirst4Value">5</span>
            <input id="weightFirst4" type="range" min="0" max="10" step="1" value="5" />
          </label>
        </fieldset>

        <fieldset>
          <legend>Jump size weights</legend>
          <label>
            Jump 1 weight: <span id="weightJump1Value">1</span>
            <input id="weightJump1" type="range" min="0" max="10" step="1" value="1" />
          </label>
          <label>
            Jump 2 weight: <span id="weightJump2Value">10</span>
            <input id="weightJump2" type="range" min="0" max="10" step="1" value="10" />
          </label>
          <label>
            Jump 3 weight: <span id="weightJump3Value">10</span>
            <input id="weightJump3" type="range" min="0" max="10" step="1" value="10" />
          </label>
          <label>
            Jump 4 weight: <span id="weightJump4Value">1</span>
            <input id="weightJump4" type="range" min="0" max="10" step="1" value="1" />
          </label>
          <label>
            Jump 5 weight: <span id="weightJump5Value">1</span>
            <input id="weightJump5" type="range" min="0" max="10" step="1" value="1" />
          </label>
        </fieldset>
      </details>

      <details class="card test-log-panel">
        <summary>Log</summary>
        <pre id="testLog" class="test-log">Le log des erreurs s'affichera ici pendant la phase TAP.</pre>
      </details>
    </main>
  </body>
</html>
