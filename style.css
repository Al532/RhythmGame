:root {
  --bg: #0f1221;
  --card: #1b2040;
  --text: #f3f5ff;
  --accent: #7be0ff;
  --ok: #79f29c;
  --warn: #ffcf6e;
  --danger: #ff758f;
  --hue-primary: 220deg;
  --hue-secondary: 340deg;
  --hue-accent: 100deg;
  --phase-sat-boost: 0%;
  --phase-light-boost: 0%;
  --noise-opacity: 0.045;
  --bpm-beat-duration: 1s;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  position: relative;
  background: var(--bg);
  color: var(--text);
  transition: background 180ms ease;
}

body.fx-background-enabled {
  background: radial-gradient(
    circle at top,
    hsl(var(--hue-primary) calc(32% + (var(--phase-sat-boost) * 0.7)) calc(10% + (var(--phase-light-boost) * 0.35))),
    color-mix(in srgb, hsl(var(--hue-secondary) 36% 7%), #04060f 74%)
  );
  animation: backgroundBpmPulse var(--bpm-beat-duration) ease-in-out infinite;
}


#fxCanvas {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 0;
}

body.fx-webgl-enabled::before,
body.fx-webgl-enabled::after {
  opacity: 0.22;
}


body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -1;
  opacity: var(--noise-opacity);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.95' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='0.55'/%3E%3C/svg%3E");
  background-size: 170px 170px;
  mix-blend-mode: screen;
  transition: opacity 240ms ease;
}

body:not(.fx-css-noise-enabled)::after {
  opacity: 0;
}

body.tap-phase.fx-background-enabled {
  background: radial-gradient(
    circle at top,
    hsl(var(--hue-accent) calc(72% + var(--phase-sat-boost)) calc(44% + (var(--phase-light-boost) * 0.9))),
    color-mix(in srgb, hsl(var(--hue-primary) 54% 20%), #0d1f11 24%)
  );
}



@keyframes patternHitFlash {
  0% {
    filter: brightness(1.16) saturate(calc(var(--tap-saturation) + 0.15));
    box-shadow:
      inset 0 0 52px color-mix(in srgb, white, transparent 78%),
      inset 0 -24px 30px color-mix(in srgb, hsl(var(--hue-accent) 72% 40%), transparent 76%),
      0 0 0 8px color-mix(in srgb, hsl(var(--hue-accent) 96% 72%), transparent 84%),
      0 20px 48px color-mix(in srgb, black, transparent 58%);
  }
  100% {
    filter: brightness(1) saturate(var(--tap-saturation));
    box-shadow:
      inset 0 0 42px color-mix(in srgb, white, transparent 88%),
      inset 0 -24px 30px color-mix(in srgb, hsl(var(--hue-accent) 72% 40%), transparent 76%),
      0 16px 42px color-mix(in srgb, black, transparent 62%);
  }
}

@keyframes tapLabelHitPulse {
  0% {
    transform: scale(0.9);
    letter-spacing: 0.06em;
    text-shadow: 0 2px 10px color-mix(in srgb, black, transparent 65%);
  }
  78% {
    transform: scale(1.38);
    letter-spacing: 0.14em;
    text-shadow: 0 0 26px color-mix(in srgb, var(--ok), transparent 28%);
  }
  100% {
    transform: scale(1);
    letter-spacing: 0.08em;
    text-shadow: 0 2px 10px color-mix(in srgb, black, transparent 65%);
  }
}

@keyframes bpmTextPulse {
  0%,
  100% {
    transform: scale(1);
    text-shadow: 0 1px 6px color-mix(in srgb, black, transparent 62%);
  }
  50% {
    transform: scale(1.08);
    text-shadow: 0 0 12px color-mix(in srgb, var(--danger), transparent 35%);
  }
}

@keyframes backgroundBpmPulse {
  0%,
  100% {
    filter: saturate(1) brightness(1);
  }
  50% {
    filter: saturate(1.08) brightness(1.04);
  }
}




.app {
  width: min(900px, 100%);
  margin: 0 auto;
  padding: 1rem;
  position: relative;
  z-index: 1;
}



.screen {
  display: grid;
  gap: 1rem;
}

.hidden {
  display: none;
}

.start-screen .app-version {
  margin: 0;
  justify-self: center;
  font-size: 0.85rem;
  opacity: 0.9;
}

.start-button {
  --globe-size: clamp(160px, 30vw, 220px);
  justify-self: center;
  position: relative;
  isolation: isolate;
  display: grid;
  place-items: center;
  width: var(--globe-size);
  aspect-ratio: 1;
  border-radius: 50%;
  overflow: hidden;
  font-size: clamp(1.6rem, 3.2vw, 2.25rem);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  border: 1px solid color-mix(in srgb, hsl(var(--hue-accent) 80% 72%), transparent 45%);
  background:
    radial-gradient(circle at 32% 26%, color-mix(in srgb, white, transparent 70%) 0%, transparent 38%),
    radial-gradient(circle at 72% 85%, color-mix(in srgb, hsl(var(--hue-secondary) 95% 70%), transparent 86%) 0%, transparent 46%),
    color-mix(in srgb, hsl(var(--hue-accent) 88% 62%), transparent 78%);
  box-shadow:
    inset 0 0 26px color-mix(in srgb, white, transparent 82%),
    inset 0 -14px 24px color-mix(in srgb, hsl(var(--hue-accent) 70% 42%), transparent 72%),
    0 10px 34px color-mix(in srgb, black, transparent 70%);
  backdrop-filter: blur(7px) saturate(140%);
}

.start-button__label {
  position: relative;
  z-index: 3;
  text-shadow: 0 2px 10px color-mix(in srgb, black, transparent 65%);
}

.start-button__liquid,
.start-button__surface,
.start-button__gloss {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.start-button__liquid {
  --tilt-x: 0;
  --tilt-y: 0;
  --line-drift: 0%;
  --line-speed: 1.15s;
  z-index: 1;
  transform-origin: 50% 54%;
  animation: liquidOrbit 5.8s ease-in-out infinite;
  transform: translate(calc(var(--tilt-x) * 4px), calc(var(--tilt-y) * 4px));
}

.start-button::before {
  content: '';
  position: absolute;
  inset: -14%;
  border-radius: 50%;
  z-index: -1;
  background: radial-gradient(circle at 50% 50%, color-mix(in srgb, hsl(var(--hue-accent) 96% 74%), transparent 72%) 0%, transparent 70%);
  filter: blur(12px);
}

.start-button__liquid::before,
.start-button__liquid::after {
  content: '';
  position: absolute;
  border-radius: 46%;
  filter: blur(1px);
}

.start-button__liquid::before {
  inset: 42% -10% -28%;
  background:
    radial-gradient(120% 90% at 50% 0%, color-mix(in srgb, white, transparent 52%) 0%, transparent 58%),
    linear-gradient(170deg, color-mix(in srgb, hsl(var(--hue-accent) 95% 72%), transparent 36%) 0%, color-mix(in srgb, hsl(var(--hue-primary) 92% 44%), transparent 44%) 82%);
  animation: liquidWave 3.2s ease-in-out infinite;
}

.start-button__liquid::after {
  inset: 50% -4% -34%;
  opacity: 0.75;
  background: linear-gradient(182deg, color-mix(in srgb, hsl(var(--hue-secondary) 92% 78%), transparent 48%) 0%, color-mix(in srgb, hsl(var(--hue-accent) 95% 56%), transparent 50%) 100%);
  animation: liquidWave 4.6s ease-in-out infinite reverse;
}

.start-button__surface {
  --tilt-x: 0;
  --tilt-y: 0;
  z-index: 2;
  background:
    radial-gradient(120% 85% at 50% 112%, color-mix(in srgb, hsl(var(--hue-secondary) 88% 70%), transparent 84%) 0%, transparent 60%),
    linear-gradient(168deg, color-mix(in srgb, white, transparent 78%) 0%, color-mix(in srgb, hsl(var(--hue-primary) 86% 58%), transparent 90%) 65%);
  mix-blend-mode: screen;
  transform: translate(calc(var(--tilt-x) * 6px), calc(var(--tilt-y) * 6px));
}

.start-button__surface::before {
  content: '';
  position: absolute;
  left: -16%;
  right: -16%;
  top: 49%;
  height: 2px;
  border-radius: 999px;
  background: linear-gradient(90deg, transparent 0%, color-mix(in srgb, white, transparent 22%) 20%, color-mix(in srgb, hsl(var(--hue-secondary) 98% 74%), transparent 18%) 50%, color-mix(in srgb, white, transparent 26%) 80%, transparent 100%);
  filter: drop-shadow(0 0 12px color-mix(in srgb, hsl(var(--hue-secondary) 100% 72%), transparent 46%));
  opacity: 0.95;
  animation: surfaceLineSweep var(--line-speed, 1.15s) linear infinite;
  transform: translateX(var(--line-drift));
}

.start-button__gloss {
  z-index: 3;
  background:
    radial-gradient(62% 42% at 34% 18%, color-mix(in srgb, white, transparent 52%) 0%, transparent 72%),
    radial-gradient(58% 35% at 68% 92%, color-mix(in srgb, white, transparent 86%) 0%, transparent 82%);
}

@keyframes liquidWave {
  0%,
  100% {
    transform: translateY(0) rotate(0deg) scaleX(1);
  }
  50% {
    transform: translateY(-8%) rotate(-3deg) scaleX(1.06);
  }
}

@keyframes surfaceLineSweep {
  0% { transform: translateX(calc(-14% + var(--line-drift))) scaleX(0.9); opacity: 0.72; }
  50% { transform: translateX(calc(8% + var(--line-drift))) scaleX(1.08); opacity: 1; }
  100% { transform: translateX(calc(26% + var(--line-drift))) scaleX(0.94); opacity: 0.78; }
}

@keyframes liquidOrbit {
  0%,
  100% {
    transform: rotate(0deg) scale(1);
  }
  50% {
    transform: rotate(6deg) scale(1.03);
  }
}

.debug-level {
  width: min(520px, 100%);
  justify-self: center;
}

.card {
  background: color-mix(
    in srgb,
    hsl(var(--hue-secondary) calc(24% + (var(--phase-sat-boost) * 0.4)) calc(20% + (var(--phase-light-boost) * 0.35))),
    var(--card) 72%
  );
  border: 1px solid color-mix(in srgb, hsl(var(--hue-accent) 78% 66%), transparent 75%);
  border-radius: 14px;
  padding: 1rem;
}

.controls {
  display: grid;
  gap: 0.85rem;
}

.control-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  align-self: end;
}

button {
  color: var(--text);
  border-radius: 10px;
  padding: 0.55rem 0.9rem;
  font-weight: 600;
  cursor: pointer;
}

.start-button {
  padding: 0;
  border-radius: 50%;
}

#calibration {
  border: 1px solid color-mix(in srgb, var(--warn), transparent 50%);
  background: color-mix(in srgb, var(--warn), transparent 82%);
}

#clearCache {
  border: 1px solid color-mix(in srgb, var(--danger), transparent 50%);
  background: color-mix(in srgb, var(--danger), transparent 82%);
}

button,
.tap-zone {
  -webkit-tap-highlight-color: transparent;
}

button:focus,
button:focus-visible,
.tap-zone:focus,
.tap-zone:focus-visible {
  outline: none;
  box-shadow: none;
}

label {
  display: grid;
  gap: 0.3rem;
}

.calibration-result {
  margin: 0;
  font-size: 0.92rem;
  opacity: 0.9;
}

summary {
  cursor: pointer;
  font-weight: 600;
  user-select: none;
}

.test-log-panel[open] summary,
.probabilities[open] summary {
  margin-bottom: 0.75rem;
}

.test-log {
  margin: 0;
  min-height: 140px;
  max-height: 280px;
  overflow: auto;
  padding: 0.75rem;
  border-radius: 10px;
  background: #121734;
  border: 1px solid #394079;
  font-size: 0.82rem;
  line-height: 1.35;
  white-space: pre-wrap;
}

.probabilities fieldset {
  border: 1px solid #3a4278;
  border-radius: 10px;
  padding: 0.75rem;
  margin: 0;
  display: grid;
  gap: 0.5rem;
}

.dual-slider-row {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.75rem;
}

.computed-setting {
  margin: 0.2rem 0 0;
  font-size: 0.92rem;
  opacity: 0.95;
}

.probabilities fieldset + fieldset {
  margin-top: 0.75rem;
}

.game-screen {
  min-height: calc(100vh - 2rem);
  place-items: center;
  align-content: center;
  position: relative;
  isolation: isolate;
}


.stop-button {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 0.8rem;
  font-weight: 800;
  letter-spacing: 0.08em;
  padding: 0.35rem 0.6rem;
  border-radius: 0 0 10px 0;
  border: 1px solid color-mix(in srgb, var(--danger), transparent 55%);
  background: color-mix(in srgb, var(--danger), transparent 84%);
  transform-origin: top left;
  animation: bpmTextPulse var(--bpm-beat-duration) ease-in-out infinite;
}

.game-level {
  margin: 0;
  font-size: 0.9rem;
  opacity: 0.9;
}


.tap-judgement {
  position: absolute;
  top: 0.35rem;
  left: 50%;
  transform: translateX(-50%) translateY(-8px);
  margin: 0;
  min-height: 1.2em;
  font-size: clamp(1.1rem, 4vw, 1.7rem);
  font-weight: 900;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  opacity: 0;
  pointer-events: none;
  transition: opacity 120ms ease, transform 160ms ease;
  text-shadow: 0 0 16px color-mix(in srgb, black, transparent 40%);
  z-index: 8;
}

.tap-judgement.is-visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.tap-judgement.perfect {
  color: #9bffcb;
}

.tap-judgement.good {
  color: #8dc5ff;
}

.tap-judgement.miss {
  color: #ff8ca0;
}

.tap-zone {
  --score-color: var(--ok);
  --fill-height: 100%;
  --tap-saturation: 1;
  --tap-sat-transition-ms: 0ms;
  --tap-tilt-x: 0;
  --tap-tilt-y: 0;
  --tap-line-drift: 0%;
  --tap-line-speed: 1.15s;
  position: relative;
  overflow: hidden;
  width: min(360px, 85vw);
  aspect-ratio: 1;
  border-radius: 999px;
  border: 4px solid color-mix(in srgb, white, transparent 58%);
  background:
    radial-gradient(120% 120% at 20% 12%, color-mix(in srgb, white, transparent 76%) 0%, transparent 56%),
    radial-gradient(130% 140% at 72% 88%, color-mix(in srgb, hsl(var(--hue-accent) 92% 62%), transparent 78%) 0%, transparent 72%),
    radial-gradient(circle at 50% 58%, color-mix(in srgb, hsl(var(--hue-primary) calc(38% + (var(--phase-sat-boost) * 0.35)) calc(20% + (var(--phase-light-boost) * 0.35))), transparent 8%) 0%, color-mix(in srgb, #070a18, hsl(var(--hue-secondary) 44% 16%) 40%) 82%);
  background-clip: padding-box;
  isolation: isolate;
  filter: saturate(var(--tap-saturation));
  box-shadow:
    inset 0 0 42px color-mix(in srgb, white, transparent 88%),
    inset 0 -24px 30px color-mix(in srgb, hsl(var(--hue-accent) 72% 40%), transparent 76%),
    0 16px 42px color-mix(in srgb, black, transparent 62%);
  transition: transform 100ms ease, background 140ms ease, border-color 140ms ease, box-shadow 160ms ease, filter var(--tap-sat-transition-ms) linear;
}

.tap-zone::before {
  content: '';
  position: absolute;
  inset: 4%;
  border-radius: 50%;
  border: 1px solid color-mix(in srgb, white, transparent 75%);
  opacity: 0.6;
  z-index: 5;
  pointer-events: none;
}

.tap-zone::after {
  content: '';
  position: absolute;
  inset: -14%;
  border-radius: 50%;
  z-index: -2;
  background: radial-gradient(circle at 50% 50%, color-mix(in srgb, hsl(var(--hue-accent) 96% 74%), transparent 72%) 0%, transparent 70%);
  filter: blur(12px);
}

.tap-zone__liquid,
.tap-zone__score-liquid,
.tap-zone__surface,
.tap-zone__caustics,
.tap-zone__gloss {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.tap-zone__liquid {
  z-index: 1;
  transform-origin: 50% 54%;
  animation: liquidOrbit 6s ease-in-out infinite;
  transform: translate(calc(var(--tap-tilt-x) * 6px), calc(var(--tap-tilt-y) * 6px));
}

.tap-zone__liquid::before,
.tap-zone__liquid::after {
  content: '';
  position: absolute;
  border-radius: 48%;
}

.tap-zone__liquid::before {
  inset: 14% 8% 14%;
  background:
    radial-gradient(70% 44% at 28% 20%, color-mix(in srgb, white, transparent 36%) 0%, transparent 78%),
    radial-gradient(68% 55% at 76% 74%, color-mix(in srgb, hsl(var(--hue-secondary) 96% 70%), transparent 72%) 0%, transparent 78%);
  opacity: 0.8;
  filter: blur(0.6px);
  animation: liquidWave 4.4s ease-in-out infinite;
}

.tap-zone__liquid::after {
  inset: 20% 18% 22%;
  background: radial-gradient(88% 66% at 56% 46%, color-mix(in srgb, hsl(var(--hue-primary) 92% 72%), transparent 76%) 0%, transparent 86%);
  mix-blend-mode: screen;
  opacity: 0.6;
  animation: liquidWave 5.6s ease-in-out infinite reverse;
}

.tap-zone__score-liquid {
  z-index: 2;
  inset: auto 0 0;
  height: var(--fill-height);
  border-radius: 0 0 50% 50%;
  background:
    radial-gradient(130% 88% at 50% 0%, color-mix(in srgb, white, transparent 56%) 0%, transparent 58%),
    linear-gradient(180deg, color-mix(in srgb, var(--score-color), white 18%) 0%, var(--score-color) 45%, color-mix(in srgb, var(--score-color), #05060f 34%) 100%);
  box-shadow:
    inset 0 14px 18px color-mix(in srgb, white, transparent 72%),
    inset 0 -18px 20px color-mix(in srgb, black, transparent 76%);
}

.tap-zone__score-liquid::before {
  content: '';
  position: absolute;
  left: -14%;
  right: -14%;
  top: 0;
  height: 3px;
  border-radius: 999px;
  background: linear-gradient(90deg, transparent 0%, color-mix(in srgb, white, transparent 18%) 18%, color-mix(in srgb, hsl(var(--hue-secondary) 98% 78%), transparent 20%) 48%, color-mix(in srgb, white, transparent 16%) 82%, transparent 100%);
  filter: drop-shadow(0 0 10px color-mix(in srgb, white, transparent 36%));
  transform: translateX(var(--tap-line-drift));
  animation: surfaceLineSweep var(--tap-line-speed, 1.15s) linear infinite;
}

.tap-zone__score-liquid::after {
  content: '';
  position: absolute;
  left: -8%;
  right: -8%;
  top: -6px;
  height: 15px;
  border-radius: 100% 100% 40% 40%;
  background: radial-gradient(65% 120% at 50% 100%, color-mix(in srgb, white, transparent 48%) 0%, transparent 74%);
  opacity: 0.85;
}

.tap-zone__surface {
  z-index: 3;
  mix-blend-mode: screen;
  background:
    radial-gradient(56% 38% at 30% 20%, color-mix(in srgb, white, transparent 46%) 0%, transparent 76%),
    radial-gradient(66% 50% at 70% 74%, color-mix(in srgb, hsl(var(--hue-accent) 95% 80%), transparent 82%) 0%, transparent 80%);
  transform: translate(calc(var(--tap-tilt-x) * 8px), calc(var(--tap-tilt-y) * 8px));
}

.tap-zone__caustics {
  z-index: 4;
  mix-blend-mode: screen;
  background:
    conic-gradient(from 45deg at 42% 48%, color-mix(in srgb, hsl(var(--hue-secondary) 98% 82%), transparent 90%) 0 15%, transparent 24% 46%, color-mix(in srgb, hsl(var(--hue-accent) 95% 74%), transparent 92%) 54% 66%, transparent 75% 100%);
  opacity: 0.65;
  filter: blur(0.4px) saturate(1.1);
  animation: liquidOrbit 9.2s linear infinite reverse;
}

.tap-zone__gloss {
  z-index: 6;
  background:
    radial-gradient(54% 38% at 30% 16%, color-mix(in srgb, white, transparent 30%) 0%, transparent 72%),
    radial-gradient(28% 18% at 72% 32%, color-mix(in srgb, white, transparent 48%) 0%, transparent 76%),
    radial-gradient(46% 28% at 56% 92%, color-mix(in srgb, white, transparent 88%) 0%, transparent 84%);
}


.tap-zone__text {
  position: absolute;
  inset: 0;
  z-index: 7;
  display: grid;
  place-items: center;
  font-size: clamp(1.65rem, 5.8vw, 2.7rem);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: color-mix(in srgb, white, hsl(var(--hue-secondary) 96% 80%) 18%);
  text-shadow: 0 2px 10px color-mix(in srgb, black, transparent 65%);
  pointer-events: none;
}

.tap-zone.tap-hit-pulse .tap-zone__text {
  animation: tapLabelHitPulse 180ms ease-out;
}

.tap-zone.listen-muted {
  --tap-saturation: 0.2;
}

.tap-zone.listen-release {
  --tap-saturation: 1;
}

.tap-zone.active { border-color: color-mix(in srgb, var(--ok), white 25%); }
.tap-zone.pressed { transform: scale(0.98); }
.tap-zone.pattern-hit-flash {
  animation: patternHitFlash 150ms ease-out;
}
.tap-zone.perfect {
  border-color: color-mix(in srgb, #8dffbf, white 8%);
  box-shadow:
    0 0 0 12px color-mix(in srgb, #74ffb2, transparent 74%),
    0 0 68px color-mix(in srgb, #74ffb2, transparent 24%),
    inset 0 0 34px color-mix(in srgb, white, transparent 62%);
  filter: saturate(1.28) brightness(1.12);
}
.tap-zone.correct {
  border-color: color-mix(in srgb, #78baff, white 18%);
  box-shadow: 0 0 0 6px color-mix(in srgb, #78baff, transparent 86%), 0 0 28px color-mix(in srgb, #78baff, transparent 65%);
}
.tap-zone.missed {
  border-color: color-mix(in srgb, #ff6a83, white 12%);
  box-shadow: 0 0 0 6px color-mix(in srgb, #ff6a83, transparent 84%), 0 0 34px color-mix(in srgb, #ff6a83, transparent 62%);
}

.result-screen {
  min-height: calc(100vh - 2rem);
  place-items: center;
  align-content: center;
  text-align: center;
}

@media (max-width: 700px) {
  .control-buttons { flex-direction: column; }
  .control-buttons button { width: 100%; }
}


@media (prefers-reduced-motion: reduce) {
  .start-button__liquid,
  .start-button__liquid::before,
  .start-button__liquid::after,
  .start-button__surface::before,
  .tap-zone__liquid,
  .tap-zone__liquid::before,
  .tap-zone__liquid::after,
  .tap-zone__score-liquid::before,
  .tap-zone__caustics,
  .tap-zone.pattern-hit-flash,
  .tap-zone.tap-hit-pulse .tap-zone__text,
  .stop-button,
  body.fx-background-enabled {
    animation: none;
  }
}

.tap-zone.tap-phase-active .tap-zone__text {
  font-size: clamp(1.95rem, 7vw, 3.35rem);
  letter-spacing: 0.1em;
}
